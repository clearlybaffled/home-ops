---
- name: Load crypt partition variables
  community.sops.load_vars:
    file: crypt-vars.sops.yml
    name: ca_device
    expressions: evaluate-on-load

- name: Generate random bits for crypt partition key
  command: >-
    dd
      if=/dev/urandom
      of={{ key_file | default(usb_device) }}
      bs={{ blocksize }}
      seek={{ key_offset }}
      count={{ key_size }}
      iflag=fullblock

- name: Create data partition
  community.general.parted:
    device: "{{ usb_device }}"
    label: gpt
    name: data
    part_start: "{{ crypt_offset + ((crypt_size + 1) * 1024 * 1024 / blocksize) }}s"
    part_end: "{{ key_offset - 1 }}s"
    state: present
    fs_type: ext4
    number: 1

- name: Format data partition
  community.general.filesystem:
    dev: "{{ usb_device }}1"
    fstype: ext4
    state: present

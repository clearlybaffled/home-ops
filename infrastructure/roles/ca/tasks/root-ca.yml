---
- name: Set facts
  set_fact:
    ca_name: root-ca

- name: Gather root-ca variables from controller
  setup:
  delegate_to: localhost
  when: inventory_host != localhost

- name: Open crypto container
  notify:
    - Open Root CA partition

- name: Root CA initial setup
  become: true
  include_tasks: 'directory.yml'

- name: Create Root Certificate Authority
  become: true
  environment:
    CA_HOME: "{{ ca_home }}"
    CA_NAME: "{{ ca_name }}"
  block:
    - name: Ask for passphrase
      pause:
        prompt: "Would you like to add a passphrase to the private key? ([Enter] to skip): "
        echo: false
      register: pk_passphrase
      when: pk_passphrase not defined

    - name: Copy config files to remote
      copy:
        dest: "{{ ca_home }}"
        src: "{{ item }}"
      loop:
        - ca.conf
        - req.conf

    - name: Create Private Key and CSR
      command:
        cmd: >-
          openssl req
          -new
          -config req.conf
          -keyout {{ ca_private_keyfile }}
          -subj '/C=US/O=HERMLEIGH.HOME/CN={{ root_ca_cn }}'
          -out root-ca.csr
          -passout stdin
        stdin: "{{ pk_passphrase }}"
        stdin_add_newline: false
        chdir: "{{ ca_home }}"
        creates: "{{ ca_private_keyfile }}"
      register: req

    - name: Sign CSR # noqa no-handler
      command:
        cmd: >-
          openssl ca
          -batch
          -selfsign
          -config ca.conf
          -in root-ca.csr
          -out root-ca.crt
          -extensions ca_ext
          -passin stdin
          -days 3650
          -crldays 365
        stdin: "{{ pk_passphrase }}"
        stdin_add_newline: false
        chdir: "{{ ca_home }}"
        creates: root-ca.crt
      when: req is changed

- name: Save Root CA Cert to repo in a sops file
  block:
    - name: Slurp CA cert file
      slurp:
        src: "{{ ca_home }}/root-ca.crt"
      register: ca_crt_file

    - name: Save SOPS file
      community.sops.sops_encrypt:
        path: "{{ pki_dir }}/root-ca.crt"
        content_binary: "{{ ca_crt_file.content }}"
      delegate_to: localhost

    - name: Commit SOPS file to repo
      lvrfrc87.git_acp.git_acp:
        path: "{{ root_dir }}"
        add:
          - "{{ pki_dir }}/root-ca.crt"
        comment: "Adding Root CA Certificate"
        url: "{{ git_repo_url }}"
        push: true
        branch: "{{ git_branch }}"
      delegate_to: localhost
      tags:
        - commit

- name: Close crypto container
  notify:
    - Close Root CA volume

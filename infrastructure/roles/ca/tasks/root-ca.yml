---
- name: Set CA home directory
  set_fact:
    ca_home: "{{( pki_home, 'root-ca') | path_join }}"

- name: Set up Root CA data directories
  include_tasks: 'directory.yml'

- name: Create Private Key and CSR
  environment:
    CA_HOME: "{{ ca_home }}"
  command:
    cmd: >-
      openssl req
      -new
      -config {{ role_path }}/files/root-ca.conf
      -keyout {{ ca_home }}/private/root-ca.key
      -out {{ ca_home }}/root-ca.csr

- name: Sign CSR
  environment:
    CA_HOME: "{{ ca_home }}"
  command:
    cmd: >-
      openssl ca
      -batch
      -selfsign
      -config {{ role_path }}/files/root-ca.conf
      -in {{ ca_home }}/root-ca.csr
      -out {{ ca_home }}/root-ca.crt
      -extensions ca_ext

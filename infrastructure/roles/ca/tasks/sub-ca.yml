---
- name: Ensure the sub ca has a name
  assert:
    that: "ca_name is defined"

- name: Set Sub CA home
  set_fact:
    home: "{{ ('srv','pki', ca_name ) | path_join}}"

- name: Setup directory
  include_tasks: directory.yml

- name: Generate private key and CSR
  command:
    cmd: >-
      openssl req
      -nodes
      -new
      -config {{ role_path }}/files/sub-ca.conf
      -out {{ home }}/{{ ca_name }}-ca.csr
      -keyout {{ home }}/private/ca.key

- name: Sign CSR with Root CA
  command:
    cmd: >-
      openssl ca
      -config {{ role_path }}/files/root-ca.conf
      -in {{ home }}/{{ ca_name }}-ca.csr
      -out {{ home }}/ca.crt
      -extensions sub_ca_ext

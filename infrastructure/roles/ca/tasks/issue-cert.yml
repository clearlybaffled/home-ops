---
- name: Check inputs
  assert:
    that:
      - "signing_ca is defined and ((pki_home, signing_ca)|path_join) is directory"
      - csr_path is exists
      - purpose is defined
      - purpose != 'sub_ca' or (purpose == 'sub_ca' and signing_ca == 'root-ca')

- name: Issue Signed Certificate
  become: true
  become_user: root
  command:
    cmd: >-
       openssl ca
       -batch
       -config {{ role_path }}/files/{{ (signing_ca == 'root-ca') | ternary('root-ca','sub-ca') }}.conf
       -in {{ csr_path }}
       -out {{ (csr_path | dirname, (csr_path | splitext | first)+'.crt' ) | path_join}}
       -extensions {{ purpose }}_ext
  environment:
    CA_NAME: "{{ signing_ca }}"
    CA_HOME: "{{ (pki_home, signing_ca) | path_join }}"
    CN: "{{ common_name  | default(omit) }}"

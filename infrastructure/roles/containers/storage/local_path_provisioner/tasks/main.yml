---
- name: Local Path Provisioner | Create claim root dir
  delegate_to: "{{ groups['kube_control_plane'][0] }}"
  file:
    path: "{{ local_path_provisioner_claim_root }}"
    state: directory
    mode: 0755

- name: Local Path Provisioner | Apply manifests
  kubernetes.core.k8s:
    name: "{{ item.name }}"
    namespace: "{{ local_path_provisioner_namespace }}"
    state: present
    definition: "{{ lookup('template', item.file ~ '.j2') }}"
  with_items:
    - { name: local-path-storage-ns, file: local-path-storage-ns.yml, type: ns }
    - { name: local-path-storage-sa, file: local-path-storage-sa.yml, type: sa }
    - { name: local-path-storage-cr, file: local-path-storage-cr.yml, type: cr }
    - { name: local-path-storage-clusterrolebinding, file: local-path-storage-clusterrolebinding.yml, type: clusterrolebinding }
    - { name: local-path-storage-cm, file: local-path-storage-cm.yml, type: cm }
    - { name: local-path-storage-deployment, file: local-path-storage-deployment.yml, type: deployment }
    - { name: local-path-storage-sc, file: local-path-storage-sc.yml, type: sc }

---
- name: Define local-storage PersistentVolumes for cross-namespace access
  block:
    - name: Define PersistentVolumes
      kubernetes.core.k8s:
        ca_cert: "{{ cluster_cacerts }}"
        server_side_apply:
          field_manager: ansible
        definition:
          kind: PersistentVolume
          api_version: v1
          metadata:
            name: "{{ item[1].name }}-{{ item[0] }}"
          spec:
            capacity:
              storage: "{{ item[1].size }}"
            volumeMode: Filesystem
            accessModes:
              - ReadWriteMany
            persistentVolumeReclaimPolicy: Retain
            storageClassName: local-storage
            local:
              path: "{{ item[1].path }}"
            nodeAffinity:
              required:
                nodeSelectorTerms:
                  - matchExpressions:
                      - key: kubernetes.io/hostname
                        operator: In
                        values:
                          - parche
      loop: "{{ storage.namespaces | product(storage.volumes) }}"

---
- name: Install kubeadm.config file
  template:
    src: kubeadm-config.yml.j2
    dest: "{{ kube_config_dir }}/kubeadm-config.yml"
    owner: "{{ kube_owner }}"
    mode: "0640"

- name: kubeadm | Check if kubeadm has already run
  stat:
    path: "/var/lib/kubelet/config.yaml"
    get_attributes: false
    get_checksum: false
    get_mime: false
  register: kubeadm_already_run

- name: Create control plane with kubeadm
  command: "{{ bin_dir }}/kubeadm init --config {{ kube_config_dir }}/kubeadm-config.yml"
  changed_when: false
  when: not kubeadm_already_run.stat.exists

- name: Apply crun Runtime class
  kubernetes.core.k8s:
    kind: RuntimeClass
    api_version: node.k8s.io/v1
    kubeconfig: "{{ kubeconfig_file }}"
    resource_definition: |-
      metadata:
        name: crun
      handler: crun

- name: Create cluster user for ansible
  include_role:
    name: kubernetes/users
  vars:
    kube_user: ansible-admin
    username: "{{ ansible_user }}"
    groupname: "{{ ansible_group }}"

- name: Write kubeconfig
  copy:
    dest: "{{ ansible_home }}/.kube/config"
    content: "{{ kubeconfig }}"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_group }}"
    mode: "0600"
    force: true

---
- name: Install kubeadm.config file
  template:
    src: kubeadm-config.yml.j2
    dest: "{{ kube_config_dir }}/kubeadm-config.yml"
    owner: "{{ kube_owner }}"
    mode: "0640"

- name: kubeadm | Check if kubeadm has already run
  stat:
    path: "/etc/kubernetes/admin.config"
    get_attributes: false
    get_checksum: false
    get_mime: false
  register: kubeadm_already_run
  any_errors_fatal: false

- name: kubeadm | Initialize first master
  command: >-
    timeout -k {{ kubeadm_init_timeout }} {{ kubeadm_init_timeout }}
    {{ bin_dir }}/kubeadm init
    --config={{ kube_config_dir }}/kubeadm-config.yml
    --ignore-preflight-errors=all
    --skip-phases={{ kubeadm_init_phases_skip | join(',') }}
    {{ kube_external_ca_mode | ternary('', '--upload-certs') }}
  register: kubeadm_init
  # Retry is because upload config sometimes fails
  retries: 3
  until: kubeadm_init is succeeded or "field is immutable" in kubeadm_init.stderr
  when: inventory_hostname == groups["kube_control_plane"][0] # and not kubeadm_already_run.stat.exists
  failed_when: kubeadm_init.rc != 0 and "field is immutable" not in kubeadm_init.stderr
  environment:
    PATH: "{{ bin_dir }}:{{ ansible_env.PATH }}"
  notify: Kubelet | restart kubelet

# - name: Create cluster user for ansible
#   include_role:
#     name: kubernetes/users
#   vars:
#     kube_user: ansible-admin
#     username: "{{ ansible_user }}"
#     groupname: "{{ ansible_group }}"

# - name: Write kubeconfig
#   copy:
#     dest: "{{ ansible_home_dir }}/.kube/config"
#     content: "{{ kubeconfig }}"
#     owner: "{{ ansible_user }}"
#     group: "{{ ansible_group }}"
#     mode: "0600"
#     force: true

---
- name: Localhost setup
  delegate_to: localhost
  block:
    - name: Set Homedir
      set_fact:
        home_directory: "{{ lookup('env','HOME') }}"
        local_user: "{{ lookup('env','USER') }}"

    - name: Create kube config dir for current/ansible become user
      delegate_to: localhost
      file:
        path: "{{ home_directory }}/.kube"
        owner: "{{ lookup('env','USER') }}"
        mode: "0700"
        state: directory

    - name: Install windows clients
      include_tasks: windows.yml
      when: ansible_os_family|lower == "windows"

    - name: Create cluster user for local controller user
      include_role:
        name: kubernetes/users
      vars:
        kube_user: "{{ local_user }}"
        username: "{{ local_user }}"
        groupname: "{{ local_user }}"
        dest_dir: "{{ home_directory }}/.kube"

- name: Setup local binary clients
  include_tasks: binary.yml
  vars:
    binary: "{{ item }}"
  loop:
    - kubectl
    - helm
    - argocd

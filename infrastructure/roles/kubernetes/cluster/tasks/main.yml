---
- name: Copy template kustomize yaml to tempdir
  template:
    src: "{{ item }}.yaml.j2"
    dest: "{{ playbook_dir }}/../cluster/argocd/{{ item }}.yaml"
    mode: "0644"
  register: kustomize
  with_items:
    - kustomization
  # failed_when: kustomize.changed

- name: Create argocd namespace
  kubernetes.core.k8s:
    api_version: v1
    kind: Namespace
    inline: |-
      metadata:
        name: argocd

- name: Apply argocd manifest
  kubernetes.core.k8s:
    definition: "{{ lookup('kubernetes.core.kustomize', dir='github.com/argoproj/argo-cd/manifests/crds?ref='+argocd_version) | from_yaml_all }}"
    namespace: argocd

- name: Wait for all argocd crds to load
  command: |-
    kubectl -n argocd wait --timeout=60s --for condition=Established \
      crd/applications.argoproj.io \
      crd/applicationsets.argoproj.io

- name: Kick off cluster boostrap
  kubernetes.core.k8s:
    # definition: "{{ lookup('file', playbook_dir+'/../cluster/argocd/argocd.yaml') | from_yaml_all }}"
    definition: "{{ lookup('kubernetes.core.kustomize', dir=playbook_dir+'/../cluster/argocd') | from_yaml_all }}"

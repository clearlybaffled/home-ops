---
- name: Kubernetes Apps | Check cluster settings for MetalLB
  fail:
    msg: "MetalLB require kube_proxy_strict_arp = true, see https://github.com/danderson/metallb/issues/153#issuecomment-518651132"
  when:
    - "kube_proxy_mode == 'ipvs' and not kube_proxy_strict_arp"

- name: Kubernetes Apps | Check cluster settings for MetalLB
  fail:
    msg: "metallb_ip_range is mandatory to be specified for MetalLB"
  when:
    - metallb_ip_range is not defined or not metallb_ip_range

- name: Kubernetes Apps | Create MetalLB resources and replace existing
  kubernetes.core.k8s:
    src: "https://raw.githubusercontent.com/metallb/metallb/{{ metallb_version }}/config/manifests/metallb-native.yaml"
    wait: true
    wait_sleep: 10
    wait_timeout: 360
    wait_condition:
      status: "True"
      type: Available
  when:
    - "inventory_hostname == groups['kube_control_plane'][0]"

- name: Kubernetes Apps | Install and configure MetalLB
  kubernetes.core.k8s:
    name: "MetalLB"
    template: "{{ item }}.j2"
  become: true
  with_items: ["pools.yaml", "layer2.yaml"]
  when:
    - "inventory_hostname == groups['kube_control_plane'][0]"

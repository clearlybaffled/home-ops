---
- name: Build up app_list to include some conventions for file locations and sort by wave
  tags: always
  set_fact:
    app_list: >-
      {{
          app_list | default([]) +
          [
            item.1 | combine({
              'name': item.0,
              'app_dir': (
                  cluster_dir,
                  ('path' in item.1) |
                    ternary(
                      item.1.path|default(omit) if (item.1.path|default(omit) == '') else ('apps', item.1.path|default(omit)),
                      ('apps', item.1.namespace)
                    ),
                  item.0
                ) | flatten |  path_join,
              'manifest_file':
                (
                  cluster_dir,
                  'bootstrap',
                  ('path' in item.1) | ternary(item.1.path, item.1.namespace),
                  item.0+'.yaml'
                ) | path_join
            })
          ]
      }}
  loop: >-
      {{
        (
          (apps | items | selectattr('1.wave','defined') | sort(attribute='1.wave')) +
          (apps | items | rejectattr('1.wave','defined'))
        )
      }}
  loop_control:
    label: "{{ item.0 }}"

- name: Make app loop
  set_fact:
    app_loop: "{{ app_loop | default([]) + [app] }}"
  loop: "{{ app_list }}"
  loop_control:
    loop_var: app
    label: "{{ app.name }}"
  when:
    # Don't include if app.createApp is false
    - app.createApp | default(true)
    # Start deploying when argument app_start_wave is app.wave
    - app.wave|default(10)|int >= app_start_wave|default(omit)|int
    # If there's an argument called app_deploy_list, only include the app if its present
    - app.name in app_deploy_list|default(apps.keys())
    # If there's an argument called app_reject_list, don't include this app if its present
    - app.name not in app_reject_list|default(omit)
    # Use the argument start_at to get the name of an app to start processing at
    #- ansible_loop.index0 >=  (app_list | map(attribute='name')).index(start_at )
  tags: always

- name: Install Application specific configurations and files
  include_tasks: application.yml
  loop: "{{ app_loop }}"
  loop_control:
    loop_var: app
    label: "{{ app.name }}"
    extended: true
    # extended_allitems: false
  tags: always
  vars:
    mysql_app: "{{ app_list | selectattr('name','eq','mysql') | first }}"
    postgres_app: "{{ app_list | selectattr('name','eq','cloudnative-pg') | first }}"
    mysql_secret: >-
      {{
        lookup(
          'community.sops.sops',
          (
            mysql_app.app_dir,
            mysql_app.secrets.keys() | first ~ '.sops.yaml'
          ) | path_join
        ) | from_yaml
      }}
    postgres_secret: >-
      {{
        lookup(
          'community.sops.sops',
          (
            postgres_app.app_dir,
            postgres_app.secrets | items | selectattr('1.data.username','eq', 'postgres') | first | first ~ '.sops.yaml'
          ) | path_join
        ) | from_yaml
      }}

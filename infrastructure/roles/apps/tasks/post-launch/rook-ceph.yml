---
- name: Wait for Ceph cluster to be healthy
  kubernetes.core.k8s_info:
    kind: CephCluster
    api_version: ceph.rook.io/v1
    namespace: rook-ceph
    name: rook-ceph
    wait: true
    wait_sleep: "{{ 3 * 60 }}"
    wait_timeout: "{{ 15 * 60 }}"
    wait_condition:
      type: Ready
      reason: ClusterCreated
      status: 'True'

- name: Create fstab for direct-mount pod
  kubernetes.core.k8s:
    kind: ConfigMap
    api_version: v1
    namespace: rook-ceph
    name: mount-sh
    definition:
      data:
        mount.sh: |-
          umask 077
          ceph auth get-key client.admin > /etc/ceph/admin.secret
        fstab: |-
          admin@.k8s-hdd-fs=/     /mnt    ceph    secretfile=/etc/ceph/admin.secret,noatime,_netdev   0   0

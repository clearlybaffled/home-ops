---
- name: argocd | Check for existing deployment
  kubernetes.core.k8s_info:
    kind: Application
    api_version: argoproj.io/v1alpha1
    namespace: argocd
    name: argocd
  register: argocd_app
  ignore_errors: true

- name: argocd | Launch ArgoCD
  kubernetes.core.k8s:
    definition: "{{ lookup('kubernetes.core.kustomize', dir=app.app_dir, binary_path=root_dir+'/scripts/kustomize') }}"
    server_side_apply:
      field_manager: ansible
  tags: argocd
  when: argocd_app is not success

- name: argocd | Remove chart directories generated by kustomize
  file:
    path: "{{ app.app_dir }}/charts"
    state: absent

- name: argocd | Install sops-age-key secret to ArgoCD Namespace for KSOPS
  kubernetes.core.k8s:
    api_version: v1
    kind: Secret
    namespace: argocd
    name: sops-age-key
    definition:
      data:
        keys.txt: "{{ lookup('file', lookup('env','SOPS_AGE_KEY_FILE')) | b64encode }}"

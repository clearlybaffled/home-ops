---
- name: Generate passwords and write sops file
  block:
    - name: Generate random password
      set_fact:
        "{{ secret_spec.name }}_password": "{{ lookup('password','/dev/null', length=30) }}"
      loop: "{{ secret.value.data.values() | select('mapping') | selectattr('type', 'equalto', 'password') }}"
      loop_control:
        loop_var: secret_spec
      register: generated_passwords

    - name: Write out SOPS file
      community.sops.sops_encrypt:
        path: "{{ sops_file }}"
        encrypted_regex: "^(data|stringData)$"
        content_yaml: "{{ lookup('template', 'secret.yaml.j2', convert_data=false) | from_yaml}}"

  always:
    - name: Unset password facts
      set_fact:
        "{{ secret_spec.name }}_{{ secret_spec.type }}":
      loop: "{{ secret.value.data.values() | select('mapping') }}"
      loop_control:
        loop_var: secret_spec

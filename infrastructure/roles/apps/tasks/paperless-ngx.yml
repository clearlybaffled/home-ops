---
- name: paperless-ngx | Create postgres resources
  vars:
    secret: "{{ lookup('community.sops.sops', app.app_dir+'/secret.sops.yaml') }}"
  block:
    - name: Create user
      community.postgresql.postgresql_user:
        name: "{{ secret.data['PAPERLESS_DBUSER'] | b64decode  }}"
        password: "{{ secret.data['PAPERLESS_DBPASS'] | b64decode }}"
        state: present
        login_user: "{{ postgres_admin.username | b64decode }}"
        login_password: "{{ postgres_admin.password | b64decode }}"
        host: cnpg-cluster-rw.db

    - name: Create database
      community.postgresql.postgresql_db:
        name: paperless
        owner: "{{ secret.data['PAPERLESS_DBUSER'] | b64decode  }}"
        state: present
        login_user: "{{ postgres_admin.username | b64decode }}"
        login_password: "{{ postgres_admin.password | b64decode }}"
        host: cnpg-cluster-rw.db

---
- name: Configure ClusterIssuer
  block:
    - name: Configure ClusterIssuer
      kubernetes.core.k8s:
        template: issuer.yaml.j2
        ca_cert: "{{ cluster_cacerts }}"
      vars:
        cert_chain: |-
          {{ lookup('file', (pki_dir, 'kubernetes-ca','ca.pem')|path_join) }}
          {{ lookup('file', (pki_dir, 'root-ca','ca.pem')|path_join) }}
        key: "{{ lookup('file', (pki_dir, 'kubernetes-ca', 'ca.key')|path_join)|string|b64encode }}"
  always:
    - name: Clear certs from memory
      set_fact:
        cert_chain: ""
        key: ""

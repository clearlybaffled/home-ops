---
- name: Install Cert Manager
  kubernetes.core.helm:
    release_name: cert-manager
    release_namespace: "{{ cert_manager_namespace }}"
    chart_ref: jetstack/cert-manager
    chart_version: "{{ cert_manager_version | regex_replace('^v') }}"
    values: "{{ lookup('file', 'values.yaml') | from_yaml }}"
    create_namespace: true

- name: Install Trust Manager
  kubernetes.core.helm:
    release_name: trust-manager
    release_namespace: "{{ cert_manager_namespace }}"
    chart_ref: jetstack/trust-manager

- name: Configure ClusterIssuer
  block:
    - name: Configure ClusterIssuer
      kubernetes.core.k8s:
        template: issuer.yaml.j2
        ca_cert: "{{ cluster_cacerts }}"
      vars:
        cert_chain: |-
          {{ lookup('file', (pki_dir, 'kubernetes-ca','ca.pem')|path_join) }}
          {{ lookup('file', (pki_dir, 'root-ca','ca.pem')|path_join) }}
        key: "{{ lookup('file', (pki_dir, 'kubernetes-ca', 'ca.key')|path_join)|string|b64encode }}"
  always:
    - name: Clear certs from memory
      set_fact:
        cert_chain: ""
        key: ""

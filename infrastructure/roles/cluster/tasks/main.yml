---
- name: Cache DB credentials
  set_fact:
    mysql_secret: "{{ query('kubernetes.core.k8s', kind='Secret', namespace='db', resource_name='mysql')[0].data }}"
    postgres_secret: "{{ query('kubernetes.core.k8s', kind='Secret', namespace='db', resource_name='cnpg-cluster-superuser')[0].data }}"

- name: Install Application manifest files
  include_tasks: manifests.yml
  when: item.value.createApp is not defined or item.value.createApp
  loop: "{{ apps | dict2items(key_name='name') }}"
  loop_control:
    label: "{{ item.name }}"
  tags: manifests
  vars:
    app: "{{ item.value | combine({'name': item.name}) }}"
    app_dir: >-
      {{ (
          cluster_dir,
          (item.name == 'argocd') | ternary('', 'apps'),
          ('path' in item.value) | ternary(item.value.path, item.value.namespace),
          item.name
        ) | path_join
      }}


# - name: Commit changes to Kustomization files, if necessary # noqa no-handler
#   lvrfrc87.git_acp.git_acp:
#     path: "{{ root_dir }}" # noqa jinja
#     comment: "Updated ArgoCD kustomization files" # \n{{ changed_list | to_yaml }}
#     add: "{{ changed_list }}"
#     url: "ssh://github.com/clearlybaffled/homelab"
#     push: true
#     branch: development
#     ssh_params:
#       key_file: "/home/jared/.ssh/github_clearlybaffled"
#   when: applications is changed or kustomize is changed
#   vars:
#     changed_list: "{{ kustomize.results | select('changed') | map(attribute='invocation.module_args.dest') | map('relpath',root_dir)}}"
#   tags:
#     - manifests

- name: Install ArgoCD
  kubernetes.core.k8s:
    definition: "{{ lookup('kubernetes.core.kustomize', dir=((cluster_dir, 'argocd')|path_join), binary_path=root_dir+'/scripts/kustomize') }}"
    ca_cert: "{{ cluster_cacerts }}"
    server_side_apply:
      field_manager: ansible
  tags: argocd

- name: Bootstrap cluster
  kubernetes.core.k8s:
    src: "{{ (cluster_dir, 'bootstrap.yaml') | path_join }}"
    ca_cert: "{{ cluster_cacerts }}"
    server_side_apply:
      field_manager: ansible
  tags: bootstrap

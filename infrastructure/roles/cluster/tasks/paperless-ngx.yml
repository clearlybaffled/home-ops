---
- name: paperless-ngx | Create postgres resources
  block:
    - name: Create user
      community.postgresql.postgresql_user:
        name: paperless
        password: "{{ (lookup('community.sops.sops', app.app_dir+'/secret.sops.yaml') | from_yaml).data['db_password'] | b64decode }}"
        state: present
        login_user: "{{ postgres_admin.username | b64decode }}"
        login_password: "{{ postgres_admin.password | b64decode }}"
        host: cnpg-cluster-rw.db

    - name: Create database
      community.postgresql.postgresql_db:
        name: paperless
        owner: paperless
        state: present
        login_user: "{{ postgres_admin.username | b64decode }}"
        login_password: "{{ postgres_admin.password | b64decode }}"
        host: cnpg-cluster-rw.db

---
- name: Print app name
  debug:
    msg: "-----Configuring {{ app.name }}--------"

- name: Manage app secrets
  when: app.secrets is defined
  block:
    - name: Generate secrets
      include_tasks: generate_secret.yml
      loop: "{{ app.secrets | dict2items(key_name='name') }}"
      loop_control:
        loop_var: secret
      when: sops_file is not file
      vars:
        sops_file: "{{ (app_dir, secret.name+'.sops.yaml')| path_join }}"

    - name: Render KSOPS generator template
      template:
        src: secret-generator.yaml.j2
        dest: "{{ app_dir }}/secret-generator.yaml"
      register: ksops

- name: "ArgoCD application manifest"
  blockinfile:
    block: "{{ lookup('template', 'application.yaml.j2', convert_data=false) }}"
    dest: "{{ manifest_file }}"
    mode: "0644"
    create: true
  register: application
  when: app.createApp is not defined or app.createApp

- name: "Install Kustomization file"
  blockinfile:
    block: "{{ lookup('template', 'kustomization.yaml.j2', convert_data=false) }}"
    dest: "{{ app_dir }}/kustomization.yaml"
    mode: "0644"
    create: true
  register: kustomization
  when: ('kustomize' in app) or ('secrets' in app)

- name: "Install PersistentVolumeClaim file"
  blockinfile:
    block: "{{ lookup('template', 'pvc.yaml.j2', convert_data=false) }}"
    dest: "{{ app_dir }}/pvc.yaml"
    mode: "0644"
    create: true
  when: app.pvc is defined and app.pvc
  register: pvc

- name: "Application specific configuration"
  include_tasks: "{{ taskfile }}"
  with_first_found:
    - files:
        - "{{ app.name }}.yml"
      skip: true
  loop_control:
    loop_var: taskfile
  register: app_tasks

# - name: Commit changes to app files
#   lvrfrc87.git_acp.git_acp:
#     path: "{{ root_dir }}"
#     comment: "[{{ app.name }}] Updated application manifest files"
#     add:
#       - "{{ app_dir }}"
#       - "{{ manifest_file }}"
#     url: "{{ repo_url }}"
#     push: false
#     branch: "{{ branch }}"
#     ssh_params:
#       key_file: "{{ lookup('env', 'HOME') }}/.ssh/id_rsa"
#   when: (application is changed) or
#         (ksops is changed) or
#         (kustomization is changed) or
#         (pvc is changed)

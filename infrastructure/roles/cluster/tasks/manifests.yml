---
- name: "ArgoCD application manifest"
  blockinfile:
    block: "{{ lookup('template', 'application.yaml.j2', convert_data=false) }}"
    dest: "{{ (cluster_dir, 'manifests', ('path' in app) |ternary(app.path, app.namespace), app.name+'.yaml') | path_join }}"
    mode: "0644"
    create: true
  register: applications
  when: app.createApp is not defined or app.createApp

- name: "Install Kustomization file"
  blockinfile:
    block: "{{ lookup('template', 'kustomization.yaml.j2', convert_data=false) }}"
    dest: "{{ app_dir }}/kustomization.yaml"
    mode: "0644"
    create: true
  register: kustomziation
  when: app.kustomize is defined and app.kustomize

- name: "Install PersistentVolumeClaim file"
  blockinfile:
    block: "{{ lookup('template', 'pvc.yaml.j2', convert_data=false) }}"
    dest: "{{ app_dir }}/pvc.yaml"
    mode: "0644"
    create: true
  when: app.pvc is defined and app.pvc
  register: pvc

# - name: "Additional configuration"
#   include_tasks: "{{ taskfile }}"
#   with_first_found:
#     - files:
#         - "{{ app.name }}.yml"
#       skip: true
#   loop_control:
#     loop_var: taskfile

---
- name: install | kubeadm
  when: kubeadm_file is not exists
  vars:
    kubeadm_file: "{{ bin_dir }}/kubeadm"
  block:
    - name: install | kubeadm | download
      include_tasks: ../../../download/tasks/download_file.yml
      vars:
        download: "{{ download_defaults | combine(downloads.kubeadm) }}"
    - name: install | kubeadm | Copy binary from download dir
      copy:
        src: "{{ download_cache_dir }}/kubeadm-{{ kubeadm_version }}-{{ image_arch }}"
        dest: "{{ bin_dir }}/kubeadm"
        mode: "0755"
        remote_src: true
      when:
        - not inventory_hostname in groups['kube_control_plane']

- name: install | kubectl
  when: kubectl_file is not exists
  vars:
    kubectl_file: "{{ bin_dir }}/kubectl"
  block:
    - name: install | kubectl | download
      include_tasks: ../../../download/tasks/download_file.yml
      vars:
        download: "{{ download_defaults | combine(downloads.kubectl) }}"
    - name: install | kubectl | Copy binary from download dir
      copy:
        src: "{{ download_cache_dir }}/kubectl-{{ kube_version }}-{{ image_arch }}"
        dest: "{{ bin_dir }}/kubectl"
        mode: "0755"
        remote_src: true

- name: install | kubelet
  when: kubelet_file is not exists
  vars:
    kubelet_file: "{{ bin_dir }}/kubelet"
  block:
    - name: install | kubelet | download
      include_tasks: ../../../download/tasks/download_file.yml
      vars:
        download: "{{ download_defaults | combine(downloads.kubelet) }}"
    - name: install | Copy kubelet binary from download dir
      copy:
        src: "{{ download_cache_dir }}/kubelet-{{ kube_version }}-{{ image_arch }}"
        dest: "{{ bin_dir }}/kubelet"
        mode: "0755"
        remote_src: true
      notify: Node | restart kubelet

---
- name: Include vars
  include_vars: argocd.yml

- name: Kubernetes Apps | Set ArgoCD namespace for remote manifests # noqa no-changed-when
  command: |
    {{ bin_dir }}/yq eval-all -i '.metadata.namespace="{{ argocd_namespace }}"' {{ kube_config_dir }}/{{ argocd_manifest }}
  when:
    - false
    - "inventory_hostname == groups['kube_control_plane'][0]"

- name: ArgoCD | Create namespace
  kubernetes.core.k8s:
    name: "{{ argocd_namespace }}"
    api_version: v1
    kind: namespace
    state: present

- name: Kubernetes Apps | Install ArgoCD
  kubernetes.core.k8s:
    src: "{{ kube_config_dir }}/{{ argocd_manifest }}"
    namespace: "{{ argocd_namespace }}"
    state: present
  when:
    - "inventory_hostname == groups['kube_control_plane'][0]"

# https://github.com/argoproj/argo-cd/blob/master/docs/faq.md#i-forgot-the-admin-password-how-do-i-reset-it
- name: Kubernetes Apps | Set ArgoCD custom admin password # noqa no-changed-when
  shell: |
    {{ kubectl }} -n {{ argocd_namespace }} patch secret argocd-secret -p \
      '{
        "stringData": {
          "admin.password": "{{ argocd_admin_password | password_hash('bcrypt') }}",
          "admin.passwordMtime": "'$(date +%FT%T%Z)'"
        }
      }'
  when:
    - argocd_admin_password is defined
    - "inventory_hostname == groups['kube_control_plane'][0]"

- name: Argo | Setup
  command: |-
    argocd login --core
    kubectl config set-context --current --namespace=argocd
    argocd cluster add kubernetes-admin@gato.hermleigh.home

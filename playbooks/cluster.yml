---
- name: Gather Cluster Facts
  hosts:
    - k8s_cluster
    - localhost
  tags: always
  become: true
  gather_facts: true

- name: Kubernetes Node setup
  hosts: kube_node
  gather_facts: false
  any_errors_fatal: true
  become: true
  tags: node
  roles:
    - role: kubernetes/node
    - role: download
      tags: download
      vars:
        download_container: false
      when: not skip_downloads
    - role: containers/runtime
    - role: download
      tags: download
      when: not skip_downloads
    - role: kubernetes/kubelet

- name: Install control plane
  hosts: kube_control_plane
  gather_facts: false
  any_errors_fatal: true
  become: true
  tags: control_plane
  roles:
    - kubernetes/control_plane

- name: Set up cluster infrastructure services
  hosts: kube_control_plane
  gather_facts: false
  any_errors_fatal: true
  tags: infra
  become: true
  roles:
    - containers/network
    - containers/storage
    - role: containers/storage/local_path_provisioner
      vars:
        local_path_provisioner_enabled: true
        local_path_provisioner_claim_root: /srv/cluster/volumes
        local_path_provisioner_is_default_storageclass: false

- name: Set up client on ansible controller
  hosts: localhost
  gather_facts: false
  tags: client
  roles:
    - kubernetes/client
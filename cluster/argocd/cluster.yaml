# yaml-language-server: $schema=https://github.com/datreeio/CRDs-catalog/raw/main/argoproj.io/applicationset_v1alpha1.json
---
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: cluster-helm
  namespace: argocd
spec:
  goTemplate: true
  generators:
  - git:
      repoURL: https://github.com/clearlybaffled/homelab
      revision: HEAD
      files:
        - path: cluster/**/config.json
  template:
    metadata:
      name: '{{.path.basename }}'
      namespace: argocd
      finalizers:
        - resources-finalizer.argocd.argoproj.io
    spec:
      project: default
      sources:
        - chart: '{{ default "default-helm/noop" .helm.chart }}'
          repoURL: '{{ default "https://github.com/clearlybaffled/homelab" .helm.repo }}'
          targetRevision: '{{ default "0.0.0" .helm.version }}'
          helm:
            valueFiles:
              - $cluster/'{{ .path.path }}'/values.yaml
        - repoURL: https://github.com/clearlybaffled/homelab
          path: '{{ .path.path }}'
          targetRevision: HEAD
          ref: cluster
      destination:
        name: in-cluster
        namespace: '{{ default .path.basename .namespace }}'
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        syncOptions:
          - CreateNamespace=true
          - ServerSideApply=true
